=========================
The ``viewlet`` Directive
=========================

The viewlet directive allows you to quickly register a new paglet without much
hassle, like it was shown in the `README.txt` file. Here is a sample
directive::

  >>> from zope.configuration import xmlconfig
  >>> context = xmlconfig.string('''
  ... <configure i18n_domain="zope">
  ...   <include package="zope.app.viewlet" file="meta.zcml" />
  ... </configure>
  ... ''')

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet"
  ...       for="*"
  ...       region=".test_doc.ITestRegion"
  ...       template="test_viewlet.pt"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)

As you can see, the directive looks very similar to the page directive and you
are right. The viewlet directive does not permit you to specify a `menu` and
`title`, since it is not sensible to have a menu item for a viewlet. However,
it does support two more qualifying attributes, `view` and `region`. While view
is nearly never specified (very common default), the `region` attribute *must*
be specified. An optional `weight` attribute (not shown above) allows you to
change the position of a particular viewlet relative to the others. The
default value is zero.

If we now look into the adapter registry, we will find the viewlet:

  >>> class Content(object):
  ...     pass
  >>> content = Content()

  >>> from zope.publisher.browser import TestRequest
  >>> request = TestRequest()

  >>> from zope.app.publisher.browser import BrowserView
  >>> view = BrowserView(content, request)

  >>> import zope.interface
  >>> from zope.app.viewlet.tests.test_doc import ITestRegion

  >>> import zope.component
  >>> from zope.app.viewlet.interfaces import IViewlet
  >>> viewlet = zope.component.getMultiAdapter(
  ...     (content, request, view), ITestRegion, name='testviewlet')
  >>> viewlet()
  u'<div>testviewlet macro content</div>\n'

Let's now ensure that we can also specify a viewlet class:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet2"
  ...       for="*"
  ...       region=".test_doc.ITestRegion"
  ...       template="test_viewlet.pt"
  ...       class=".test_doc.TestViewlet"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)

  >>> viewlet = zope.component.getMultiAdapter(
  ...     (content, request, view), ITestRegion, name='testviewlet2')
  >>> viewlet()
  u'<div>testviewlet macro content</div>\n'

Okay, so the template-driven cases wrok. But just specifying a class should
also work:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet3"
  ...       for="*"
  ...       region=".test_doc.ITestRegion"
  ...       class=".test_doc.TestViewlet2"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)

  >>> viewlet = zope.component.getMultiAdapter(
  ...     (content, request, view), ITestRegion, name='testviewlet3')
  >>> viewlet()
  u'called'

It should also be possible to specify an alternative attribute of the class to
be rendered upon calling the viewlet:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet4"
  ...       for="*"
  ...       region=".test_doc.ITestRegion"
  ...       class=".test_doc.TestViewlet"
  ...       attribute="doSomething"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)

  >>> viewlet = zope.component.getMultiAdapter(
  ...     (content, request, view), ITestRegion, name='testviewlet4')
  >>> viewlet()
  u'something'


Error Scenarios
---------------

Neither the class or template have been specified:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet"
  ...       region=".test_doc.ITestRegion"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)
  Traceback (most recent call last):
  ...
  ZopeXMLConfigurationError: File "<string>", line 4.2-8.8
      ConfigurationError: Must specify a class or template

The specified attribute is not ``__call__``, but also a template has been
specified:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet"
  ...       region=".test_doc.ITestRegion"
  ...       template="test_viewlet.pt"
  ...       attribute="faux"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)
  Traceback (most recent call last):
  ...
  ZopeXMLConfigurationError: File "<string>", line 4.2-10.8
      ConfigurationError: Attribute and template cannot be used together.

Now, we are not specifying a template, but a class that does not have the
specified attribute:

  >>> context = xmlconfig.string('''
  ... <configure xmlns="http://namespaces.zope.org/browser" i18n_domain="zope"
  ...            package="zope.app.viewlet.tests">
  ...   <viewlet
  ...       name="testviewlet"
  ...       region=".test_doc.ITestRegion"
  ...       class=".test_doc.TestViewlet"
  ...       attribute="faux"
  ...       permission="zope.Public"
  ...       />
  ... </configure>
  ... ''', context=context)
  Traceback (most recent call last):
  ...
  ZopeXMLConfigurationError: File "<string>", line 4.2-10.8
    ConfigurationError: The provided class doesn't have the specified attribute
